<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Burger House Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="mb-4">üîë Admin Panel</h2>

  <form id="loginForm" class="card p-3 mb-4 shadow-sm">
    <h5>Prijava</h5>
    <input id="email" class="form-control mb-2" placeholder="Email" type="email" required>
    <input id="password" class="form-control mb-2" placeholder="Lozinka" type="password" required>
    <button class="btn btn-primary w-100">Uloguj se</button>
  </form>

  <button id="logoutBtn" class="btn btn-secondary mb-4" style="display:none;">Izloguj se</button>

  <form id="addForm" class="card p-3 mb-4 shadow-sm" style="display:none;">
    <h5>Dodaj novi item</h5>
    <select id="category" class="form-select mb-2">
      <option value="food">Hrana</option>
      <option value="drinks">Piƒáe</option>
    </select>
    <input id="name" class="form-control mb-2" placeholder="Naziv" required>
    <input id="price" class="form-control mb-2" placeholder="Cena (RSD)" required>
    <button type="button" id="uploadWidgetBtn" class="btn btn-outline-secondary w-100 mb-2">Uploaduj sliku</button>
    <textarea id="desc" class="form-control mb-2" placeholder="Opis"></textarea>
    <button class="btn btn-primary w-100">Dodaj</button>
  </form>

  <div id="itemsList"></div>
</div>

<script>
  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyDqI-XnDj1zRNKweGg6yiRKAf8J8kgRrQo",
    authDomain: "burger-house-ab51a.firebaseapp.com",
    projectId: "burger-house-ab51a",
    storageBucket: "burger-house-ab51a.appspot.com",
    messagingSenderId: "31759588920",
    appId: "1:31759588920:web:cbe71c854f3885073d50cd",
    measurementId: "G-K4ZKX4RXP7"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  // Uklonjena inicijalizacija za Firebase Storage

  // --- Elementi ---
  const loginForm = document.getElementById("loginForm");
  const logoutBtn = document.getElementById("logoutBtn");
  const addForm = document.getElementById("addForm");
  const uploadBtn = document.getElementById("uploadWidgetBtn");

  // --- Cloudinary Widget ---
  let uploadedImageURL = "";
  const myWidget = cloudinary.createUploadWidget({
    cloudName: 'djnbsbare', // **Obavezno ubaci svoj cloud name**
    uploadPreset: 'burgerhouse_admin' // **Obavezno ubaci svoj upload preset**
  }, (error, result) => {
    if (!error && result && result.event === "success") {
      uploadedImageURL = result.info.secure_url;
      console.log("Slika uploadovana:", uploadedImageURL);
      // Vizuelni feedback korisniku
      uploadBtn.innerText = "‚úÖ Slika uspe≈°no uploadovana";
      uploadBtn.classList.remove("btn-outline-secondary");
      uploadBtn.classList.add("btn-success");
    }
  });

  uploadBtn.addEventListener("click", () => {
    myWidget.open();
  }, false);

  // --- Login ---
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    try {
      await auth.signInWithEmailAndPassword(email, pass);
    } catch (err) {
      alert("Gre≈°ka pri logovanju: " + err.message);
    }
  });

  logoutBtn.addEventListener("click", () => auth.signOut());

  auth.onAuthStateChanged(user => {
    if (user) {
      loginForm.style.display = "none";
      logoutBtn.style.display = "block";
      addForm.style.display = "block";
      loadItems();
    } else {
      loginForm.style.display = "block";
      logoutBtn.style.display = "none";
      addForm.style.display = "none";
      document.getElementById("itemsList").innerHTML = "";
    }
  });

  // --- Dodavanje itema ---
  addForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const category = document.getElementById("category").value;
    const name = document.getElementById("name").value;
    const price = document.getElementById("price").value;
    const desc = document.getElementById("desc").value;

    // Provera da li je slika uploadovana
    if (!uploadedImageURL) {
      alert("Morate prvo uploadovati sliku!");
      return;
    }

    // Dodavanje u bazu sa URL-om od Cloudinary-ja
    await db.collection(category).add({ name, price, desc, image: uploadedImageURL });
    
    addForm.reset();
    uploadedImageURL = ""; // Resetovanje URL-a za sledeƒái unos

    // Vraƒáanje dugmeta na poƒçetno stanje
    uploadBtn.innerText = "Uploaduj sliku";
    uploadBtn.classList.remove("btn-success");
    uploadBtn.classList.add("btn-outline-secondary");
    
    loadItems();
  });

  // --- Prikaz itema ---
  async function loadItems() {
    const listDiv = document.getElementById("itemsList");
    listDiv.innerHTML = "<h4>Postojeƒáe stavke</h4>";

    for (let category of ["food", "drinks"]) {
      const snapshot = await db.collection(category).get();
      if (!snapshot.empty) {
        listDiv.innerHTML += `<h5 class="mt-3">${category === "food" ? "Hrana" : "Piƒáe"}</h5>`;
        snapshot.forEach(doc => {
          const item = doc.data();
          listDiv.innerHTML += `
            <div class="card mb-2 p-2 shadow-sm d-flex flex-row justify-content-between align-items-center">
              <div>
                <img src="${item.image}" alt="${item.name}" width="50" height="50" class="me-3 rounded">
                <span><strong>${item.name}</strong> - ${item.price}RSD</span>
                <small class="d-block text-muted">${item.desc}</small>
              </div>
              <button class="btn btn-danger btn-sm" onclick="deleteItem('${category}','${doc.id}')">Obri≈°i</button>
            </div>`;
        });
      }
    }
  }
  
  // --- Brisanje itema ---
  async function deleteItem(category, id) {
    if (confirm("Da li ste sigurni da ≈æelite da obri≈°ete ovaj item?")) {
        await db.collection(category).doc(id).delete();
        loadItems();
    }
  }
</script>
</body>
</html>

